name: Build GoPro‑MAX FFmpeg

on:
  workflow_dispatch:           # ✋ manual “Run workflow” button
  push:                        # or auto‑run on every push to main
    branches: [ main ]

jobs:
  linux:
    name: Linux (Ubuntu) build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # Build the Docker image that turns GoPro source into fresh FFmpeg binaries
    - name: Build via Dockerfile
      run: docker build -t goproffmpeg:latest .

    # Spin up a throw‑away container & copy the goodies out
    - name: Copy artifacts from container
      run: |
        cid=$(docker create goproffmpeg:latest)
        docker cp $cid:/ffmpeg               ./ffmpeg-linux
        docker cp $cid:/ffprobe              ./ffprobe-linux
        docker cp $cid:/gopromax_opencl.ptx  ./gopromax_opencl.ptx
        docker rm $cid

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-linux
        path: |
          ffmpeg-linux
          ffprobe-linux
          gopromax_opencl.ptx

  windows:
  name: Windows (.exe) build
  runs-on: windows-latest
  steps:
  - uses: actions/checkout@v4

  - name: MSYS2 setup w/ x264
    uses: msys2/setup-msys2@v2
    with:
      msystem: MINGW64
      update: true
      install: >-
        git
        base-devel
        mingw-w64-x86_64-toolchain
        mingw-w64-x86_64-yasm
        mingw-w64-x86_64-nasm
        mingw-w64-x86_64-clang
        mingw-w64-x86_64-opencl-headers
        mingw-w64-x86_64-x264          # <‑‑‑ the missing salsa!

  - name: Build FFmpeg w/ GoPro filter + x264
    shell: msys2 {0}
    run: |
      git clone --depth 1 https://github.com/gmat/goproMax-ffmpeg-v5.git
      cd goproMax-ffmpeg-v5
      ./configure \
        --target-os=mingw32 --arch=x86_64 \
        --enable-cross-compile \
        --enable-gpl --enable-nonfree \
        --enable-opencl \
        --enable-libx264
      make -j$(nproc)

  - name: Upload Windows artifacts
    uses: actions/upload-artifact@v4
    with:
      name: ffmpeg-windows
      path: |
        goproMax-ffmpeg-v5/ffmpeg.exe
        goproMax-ffmpeg-v5/ffprobe.exe
        goproMax-ffmpeg-v5/libavfilter/opencl/gopromax_opencl.ptx
